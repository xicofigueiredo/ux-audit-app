<!DOCTYPE html>
<html>
  <head>
    <title>Audit Results - UX Audit App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <%= stylesheet_link_tag "application" %>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen bg-gray-100">
      <!-- Sidebar -->
      <%= render 'shared/app_sidebar' %>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Bar -->
        <header class="flex justify-between items-center px-6 py-4 bg-white border-b shadow-sm">
          <div class="flex items-center space-x-4">
            <%= link_to projects_path, class: "text-gray-600 hover:text-purple-600 flex items-center" do %>
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
              Back to Projects
            <% end %>
          </div>
          <div class="flex items-center space-x-4">
            <% if user_signed_in? %>
              <span class="text-gray-700 text-sm">Welcome, <%= current_user.email.split('@').first %></span>
              <%= button_to "Sign out", destroy_user_session_path, method: :delete, class: "text-gray-700 hover:text-purple-600 bg-transparent border border-gray-300 px-4 py-2 rounded-lg font-medium transition" %>
            <% end %>
          </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto">

<% if @audit.status == 'pending' %>
  <div class="analysis-app-container" style="min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem;">
    <div style="text-align: center; max-width: 600px;">
      <!-- Progress bar -->
      <div class="progress-container" style="width: 100%; max-width: 400px; margin: 0 auto 2rem;">
        <div class="progress-bar" style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
          <div class="progress-fill" style="height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 4px; transition: width 0.5s ease; width: <%= case @audit.processing_stage
            when 'uploaded' then '10%'
            when 'extracting_frames' then '30%'
            when 'analyzing_ai' then '70%'
            when 'generating_report' then '90%'
            else '50%'
          end %>;"></div>
        </div>
        <div class="progress-stages" style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: #6b7280;">
          <span style="<%= 'color: #6366f1; font-weight: 600;' if ['uploaded', 'extracting_frames', 'analyzing_ai', 'generating_report'].include?(@audit.processing_stage) %>">Upload</span>
          <span style="<%= 'color: #6366f1; font-weight: 600;' if ['extracting_frames', 'analyzing_ai', 'generating_report'].include?(@audit.processing_stage) %>">Extract</span>
          <span style="<%= 'color: #6366f1; font-weight: 600;' if ['analyzing_ai', 'generating_report'].include?(@audit.processing_stage) %>">Analyze</span>
          <span style="<%= 'color: #6366f1; font-weight: 600;' if @audit.processing_stage == 'generating_report' %>">Report</span>
        </div>
      </div>

      <!-- Animated spinner -->
      <div class="spinner" style="margin-bottom: 24px; width: 48px; height: 48px; border: 6px solid #e5e7eb; border-top: 6px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>

      <!-- Dynamic status message -->
      <h2 id="status-message" style="font-size: 1.5rem; color: #6366f1; font-weight: 700; margin-bottom: 12px;"><%= @audit.processing_stage_message %></h2>

      <!-- Time remaining estimate -->
      <p id="time-estimate" style="color: #374151; font-size: 1.1rem; margin-bottom: 1rem;"><%= @audit.estimated_time_remaining %></p>

      <!-- Helpful tip -->
      <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
        <p style="color: #64748b; font-size: 0.95rem; margin: 0;">
          üí° <strong>Pro tip:</strong> Keep this page open for the best experience. We'll automatically show your results when ready!
        </p>
      </div>
    </div>
  </div>
  <script nonce="<%= content_security_policy_nonce %>">
    // Poll every 3 seconds to check if the audit is complete and update progress
    const pollInterval = setInterval(function() {
      fetch(window.location.pathname + '.json')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'completed') {
            clearInterval(pollInterval);
            window.location.reload();
          } else if (data.status === 'failed') {
            clearInterval(pollInterval);
            window.location.reload();
          }

          // Update progress if we get processing stage info
          if (data.processing_stage) {
            updateProgress(data.processing_stage);
          }
        })
        .catch(error => {
          console.log('Polling error:', error);
          // Continue polling even if there's an error
        });
    }, 3000);

    function updateProgress(stage) {
      const progressFill = document.querySelector('.progress-fill');
      const statusMessage = document.getElementById('status-message');
      const timeEstimate = document.getElementById('time-estimate');

      const stages = {
        'uploaded': { width: '10%', message: 'Video uploaded successfully', time: '1-2 minutes remaining' },
        'extracting_frames': { width: '30%', message: 'Extracting frames from video...', time: '1-2 minutes remaining' },
        'analyzing_ai': { width: '70%', message: 'Analyzing workflow with AI...', time: '30-60 seconds remaining' },
        'generating_report': { width: '90%', message: 'Generating your UX report...', time: 'Almost done!' }
      };

      if (stages[stage]) {
        progressFill.style.width = stages[stage].width;
        statusMessage.textContent = stages[stage].message;
        timeEstimate.textContent = stages[stage].time;
      }
    }
  </script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
<% else %>
<div class="analysis-app-container">
  <!-- Header -->
  <header class="analysis-header">
    <div class="header-left">
      <div class="header-title-container">
        <h1 class="report-title">
          Workflow Report: <%= @audit.parsed_llm_response.dig('workflowSummary', 'workflowtitle') || @audit.parsed_llm_response.dig('workflowSummary', 'userGoal') || 'Analysis' %>
        </h1>
        <p class="report-subtitle">
          App: AI Talk Coach ‚Ä¢ Uploaded <%= @audit.created_at.strftime('%b %d, %Y') %> ‚Ä¢ Duration: 00:<%= '%02d' % (@audit.frames&.length || 25) %>
        </p>
      </div>
    </div>
    <div class="header-right">
      <button class="filter-btn" id="filter-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        Filters
      </button>
      <button class="export-btn" id="export-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        Export
      </button>
    </div>
  </header>

  <!-- Summary Statistics Cards -->
  <% if @audit.completed? || @audit.status == 'partial' %>
    <% if @audit.parsed_llm_response.is_a?(Hash) && @audit.parsed_llm_response["identifiedIssues"].is_a?(Array) %>
      <%
        issues = @audit.parsed_llm_response["identifiedIssues"]
        stats = calculate_severity_stats(issues)
      %>
      <div class="summary-stats-container">
        <div class="stat-card total">
          <div class="stat-label">Total Issues</div>
          <div class="stat-value"><%= stats[:total] %></div>
        </div>
        <div class="stat-card high-severity">
          <div class="stat-label">
            High Severity
            <button class="severity-info-icon" data-severity="high" data-tooltip="Blocks critical tasks - Fix this week - Click for more info" aria-label="Information about High severity">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <text x="8" y="11" text-anchor="middle" font-size="10" font-weight="bold" fill="currentColor">i</text>
              </svg>
            </button>
          </div>
          <div class="stat-value high"><%= stats[:high] %></div>
        </div>
        <div class="stat-card medium-severity">
          <div class="stat-label">
            Medium
            <button class="severity-info-icon" data-severity="medium" data-tooltip="Causes friction - Fix this month - Click for more info" aria-label="Information about Medium severity">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <text x="8" y="11" text-anchor="middle" font-size="10" font-weight="bold" fill="currentColor">i</text>
              </svg>
            </button>
          </div>
          <div class="stat-value medium"><%= stats[:medium] %></div>
        </div>
        <div class="stat-card low-severity">
          <div class="stat-label">
            Low
            <button class="severity-info-icon" data-severity="low" data-tooltip="Polish issue - Fix when you have time - Click for more info" aria-label="Information about Low severity">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <text x="8" y="11" text-anchor="middle" font-size="10" font-weight="bold" fill="currentColor">i</text>
              </svg>
            </button>
          </div>
          <div class="stat-value low"><%= stats[:low] %></div>
        </div>

        <!-- AI Summary - Full Width -->
        <% if @audit.parsed_llm_response.dig('workflowSummary', 'summary') %>
          <div class="ai-summary-container">
            <h4 class="ai-summary-heading">AI Summary</h4>
            <p class="ai-summary-text"><%= @audit.parsed_llm_response.dig('workflowSummary', 'summary') %></p>
          </div>
        <% end %>

        <!-- Timeline Bar - Full Width -->
        <div class="timeline-bar-container">
          <h4 class="timeline-heading">Timeline</h4>
          <div class="timeline-ranges">
            <% @audit.parsed_llm_response["identifiedIssues"].each_with_index do |issue, idx| %>
              <% if issue["frameReference"] %>
                <div class="timeline-dot-container" data-issue-index="<%= idx %>">
                  <div class="timeline-dot <%= issue['severity'].downcase %>"></div>
                  <span class="timeline-time"><%= frame_range_to_time(issue["frameReference"]) %></span>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Workflow Analysis - Separate Collapsible Section -->
      <% if @audit.parsed_llm_response.dig('workflowSummary') %>
        <div class="workflow-analysis-section">
          <button class="workflow-toggle-btn" id="workflow-toggle-btn">
            <span class="workflow-title"><%= @audit.parsed_llm_response['workflowSummary']['workflowtitle'] || 'Workflow Analysis' %></span>
            <svg class="chevron-workflow" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="workflow-details collapsed" id="workflow-details">
            <div class="workflow-goal">
              <strong>User Goal:</strong> <%= @audit.parsed_llm_response['workflowSummary']['userGoal'] %>
            </div>
            <% if @audit.parsed_llm_response['workflowSummary']['workflowSteps'].is_a?(Array) %>
              <div class="workflow-steps">
                <strong>Steps:</strong>
                <ol class="workflow-steps-list-compact">
                  <% @audit.parsed_llm_response['workflowSummary']['workflowSteps'].each do |step| %>
                    <% clean_step = step.gsub(/^\d+\.\s*/, '') %>
                    <li><%= clean_step %></li>
                  <% end %>
                </ol>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>

  <div class="analysis-body">

    <!-- Main Content Area -->
    <main class="analysis-main">
      <!-- Show All Button (hidden by default) -->
      <div id="show-all-container" style="display: none; margin-bottom: 20px;">
        <button id="show-all-btn" class="show-all-btn">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          Show All Issues
        </button>
      </div>
      <div class="tab-content overview-tab active">
        <% if @audit.completed? || @audit.status == 'partial' %>
          <% if @audit.parsed_llm_response.is_a?(Hash) && @audit.parsed_llm_response["identifiedIssues"].is_a?(Array) %>
            <div class="issue-card-grid">
              <% @audit.parsed_llm_response["identifiedIssues"].each_with_index do |issue, idx| %>
                <div class="issue-card" id="issue-card-<%= idx %>">
                  <!-- Issue ID and Title with Severity -->
                  <div class="issue-card-header">
                    <div class="issue-id-title">
                      <span class="issue-id">[<%= generate_issue_id(@audit.id, idx) %>]</span>
                      <h3 class="issue-title"><%= issue["painPointTitle"] %></h3>
                    </div>
                    <span class="issue-severity <%= issue["severity"].downcase %>">
                      <%= issue["severity"].capitalize %>
                    </span>
                  </div>

                  <!-- Heuristic Reference -->
                  <% if issue["heuristicViolated"].present? %>
                    <div class="issue-heuristic">
                      Heuristic: <%= extract_heuristic_label(issue["heuristicViolated"]) %>
                    </div>
                  <% end %>

                  <!-- Time -->
                  <% if issue["frameReference"] %>
                    <div class="issue-time">
                      <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
                      </svg>
                      <span class="time-label">Time:</span>
                      <span class="time-value"><%= frame_range_to_time(issue["frameReference"]) %></span>
                    </div>
                  <% end %>

                  <!-- Screenshot Section -->
                  <% screenshot = @audit.issue_screenshots.find_by(issue_index: idx) %>
                  <% if screenshot && screenshot.image_data.present? %>
                    <div class="issue-screenshot-container" style="margin-bottom: 14px;">
                      <strong style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: #111827;">Screenshot:</strong>
                      <div class="screenshot-thumbnail" data-issue-index="<%= idx %>" style="cursor: pointer; position: relative; height: 120px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; transition: all 0.2s;">
                        <img src="data:image/jpeg;base64,<%= screenshot.image_data %>"
                             alt="Issue screenshot"
                             class="issue-screenshot-img"
                             style="width: 100%; height: 100%; object-fit: cover;"
                             loading="lazy">
                        <div style="position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 0.75rem; border-radius: 4px 0 0 0;">
                          üîç Click to expand
                        </div>
                      </div>
                    </div>
                  <% end %>

                  <!-- Evidence Section -->
                  <div class="issue-evidence">
                    <strong>Evidence:</strong>
                    <%= extract_evidence(issue["issueDescription"]) %>
                  </div>

                  <!-- Recommendations -->
                  <div class="issue-recommendations">
                    <strong>Recommendations:</strong>
                    <ul>
                      <% issue["recommendations"].each do |rec| %>
                        <li><%= rec %></li>
                      <% end %>
                    </ul>
                  </div>

                  <!-- Card Actions -->
                  <div class="issue-card-actions">
                    <button class="copy-btn" data-audit-id="<%= @audit.id %>" data-issue-index="<%= idx %>">
                      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                      </svg>
                      Copy
                    </button>
                    <button class="jira-btn" data-audit-id="<%= @audit.id %>" data-issue-index="<%= idx %>">
                      <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-4H9V7h2v5z"></path>
                      </svg>
                      Jira
                    </button>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Next Steps Section -->
            <div class="next-steps-section">
              <h3 class="next-steps-heading">Next Steps</h3>
              <ul class="next-steps-list">
                <% @audit.parsed_llm_response["identifiedIssues"].group_by { |i| i["severity"] }.each do |severity, issues| %>
                  <% if severity == "High" %>
                    <% issues.each do |issue| %>
                      <li>Fix <%= issue["painPointTitle"].downcase %></li>
                    <% end %>
                  <% end %>
                <% end %>
                <% medium_issues = @audit.parsed_llm_response["identifiedIssues"].select { |i| i["severity"] == "Medium" } %>
                <% if medium_issues.any? %>
                  <li>Review and address medium severity issues</li>
                <% end %>
                <% if @audit.parsed_llm_response.dig('workflowSummary', 'workflowSteps')&.any? %>
                  <li>Consider workflow optimization opportunities</li>
                <% end %>
              </ul>
              <div class="next-steps-actions">
                <button class="jira-epic-btn" id="jira-epic-btn">Generate Jira Epic</button>
                <button class="design-task-btn" id="design-task-btn">Create Design Task</button>
              </div>
            </div>
          <% else %>
            <div class="error-message">
              Invalid analysis format. Please try again.
            </div>
          <% end %>
        <% elsif @audit.failed? %>
          <div class="error-container" style="text-align: center; padding: 3rem 2rem; max-width: 600px; margin: 0 auto;">
            <!-- Error icon -->
            <div style="margin-bottom: 1.5rem;">
              <svg style="width: 64px; height: 64px; color: #ef4444; margin: 0 auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
            </div>

            <!-- Error message -->
            <h3 style="font-size: 1.5rem; font-weight: 700; color: #dc2626; margin-bottom: 1rem;">
              Oops! Something went wrong
            </h3>

            <div class="error-message" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
              <p style="color: #7f1d1d; font-size: 1rem; margin: 0; line-height: 1.5;">
                <% if @audit.parsed_llm_response.is_a?(Hash) && @audit.parsed_llm_response["error"] %>
                  <%= @audit.parsed_llm_response["error"] %>
                <% else %>
                  <%= @audit.parsed_llm_response %>
                <% end %>
              </p>
            </div>

            <!-- Action buttons -->
            <div class="error-actions" style="display: flex; flex-direction: column; gap: 1rem; align-items: center;">
              <%= button_to video_audits_path, method: :post, params: { video_audit: { video: @audit.video } },
                    class: "retry-button",
                    style: "background: #6366f1; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 600; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px; text-decoration: none;" do %>
                <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Try Again
              <% end %>

              <%= link_to video_audits_path,
                    class: "secondary-button",
                    style: "color: #6b7280; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: background 0.2s;" do %>
                ‚Üê Upload a different video
              <% end %>
            </div>

            <!-- Help text -->
            <div style="margin-top: 2rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
              <p style="color: #64748b; font-size: 0.9rem; margin: 0;">
                üí° <strong>Having trouble?</strong> Make sure your video is under 90 seconds and in a supported format (MP4, MOV, AVI).
              </p>
            </div>
          </div>
        <% else %>
          <div class="processing">
            <div class="spinner"></div>
            <p>Processing video analysis...</p>
          </div>
        <% end %>
      </div>
    </main>
  </div>

  <!-- Severity Info Modal -->
  <div id="severityModal" class="severity-modal" style="display: none;">
    <div class="severity-modal-content">
      <button class="severity-modal-close" aria-label="Close modal">&times;</button>
      <div id="severityModalBody"></div>
    </div>
  </div>

  <!-- Screenshot Modal -->
  <div id="screenshotModal" class="screenshot-modal" style="display: none;">
    <div class="screenshot-modal-content">
      <button class="screenshot-modal-close" aria-label="Close modal">&times;</button>
      <img id="screenshotModalImage" src="" alt="Issue screenshot enlarged" style="max-width: 90%; max-height: 90vh; border-radius: 8px;">
    </div>
  </div>
</div>

<style>
.analysis-app-container {
  font-family: 'Inter', sans-serif;
  background: #f9fafb;
  min-height: 100vh;
}
.analysis-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 40px 10px 40px;
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 24px;
}
.back-link {
  color: #6366f1;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s;
}
.back-link:hover {
  color: #4f46e5;
}
.header-title-container {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.report-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1e293b;
  margin: 0;
  line-height: 1.3;
}
.report-subtitle {
  font-size: 0.85rem;
  color: #6b7280;
  margin: 0;
  font-weight: 400;
}
.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.filter-btn, .export-btn {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 6px 12px;
  font-weight: 500;
  font-size: 0.85rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  color: #374151;
  transition: all 0.2s;
}
.filter-btn:hover, .export-btn:hover {
  background: #f9fafb;
  border-color: #d1d5db;
}

/* Summary Statistics Cards */
.summary-stats-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  padding: 16px 40px 12px 40px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}
.stat-card {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 10px 14px;
  text-align: left;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.stat-label {
  font-size: 0.8rem;
  color: #6b7280;
  font-weight: 500;
  display: flex;
  align-items: center;
}
.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
  flex-shrink: 0;
}
.stat-card.total .stat-value {
  color: #6366f1;
  font-weight: 800;
}
.stat-value.high { color: #dc2626; }
.stat-value.medium { color: #f59e0b; }
.stat-value.low { color: #2563eb; }

/* AI Summary Section */
.ai-summary-container {
  grid-column: 1 / -1;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px 20px;
  margin-top: 4px;
}

.ai-summary-heading {
  font-size: 0.9rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 8px 0;
  letter-spacing: 0.3px;
}

.ai-summary-text {
  font-size: 0.95rem;
  color: #374151;
  line-height: 1.6;
  margin: 0;
}

/* Timeline Bar - Full Width */
.timeline-bar-container {
  grid-column: 1 / -1;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px 20px;
  margin-top: 4px;
}

.timeline-heading {
  font-size: 0.8rem;
  font-weight: 600;
  color: #1e293b;
  margin: 0 0 16px 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.timeline-ranges {
  display: flex;
  align-items: flex-start;
  gap: 0;
  position: relative;
  padding: 8px 0;
}

.timeline-ranges::before {
  content: '';
  position: absolute;
  top: 18px;
  left: 8px;
  right: 8px;
  height: 2px;
  background: #e5e7eb;
  z-index: 0;
}

.timeline-dot-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  position: relative;
  z-index: 1;
  flex: 1;
  min-width: 60px;
}

.timeline-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.2s;
}

.timeline-dot.high {
  background: #dc2626;
}

.timeline-dot.medium {
  background: #f59e0b;
}

.timeline-dot.low {
  background: #2563eb;
}

.timeline-dot-container:hover .timeline-dot {
  transform: scale(1.3);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.timeline-time {
  font-size: 0.7rem;
  color: #6b7280;
  font-family: monospace;
  font-weight: 500;
  white-space: nowrap;
}

/* Workflow Analysis Section */
.workflow-analysis-section {
  background: #fff;
  padding: 12px 40px;
  border-bottom: 1px solid #e5e7eb;
}

.workflow-toggle-btn {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 10px 16px;
  font-size: 0.9rem;
  font-weight: 600;
  color: #1e293b;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  justify-content: space-between;
}

.workflow-toggle-btn:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
}

.workflow-title {
  font-size: 0.9rem;
  color: #1e293b;
  font-weight: 600;
}

.chevron-workflow {
  transition: transform 0.3s ease;
  flex-shrink: 0;
}

.workflow-details {
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease;
  background: #f9fafb;
  border-radius: 6px;
}

.workflow-details.collapsed {
  max-height: 0;
  opacity: 0;
  padding: 0 16px;
}

.workflow-details.expanded {
  max-height: 600px;
  opacity: 1;
  padding: 16px;
  margin-top: 10px;
}

.workflow-goal {
  font-size: 0.85rem;
  color: #374151;
  margin-bottom: 12px;
  line-height: 1.6;
}

.workflow-goal strong {
  color: #1e293b;
  font-weight: 600;
}

.workflow-steps {
  font-size: 0.85rem;
  color: #374151;
}

.workflow-steps strong {
  color: #1e293b;
  font-weight: 600;
  display: block;
  margin-bottom: 8px;
}

.workflow-steps-list-compact {
  margin: 0 0 0 20px;
  padding: 0;
  font-size: 0.85rem;
  color: #374151;
  line-height: 1.6;
}

.workflow-steps-list-compact li {
  margin-bottom: 6px;
}

.analysis-body {
  background: #f9fafb;
}

.analysis-main {
  width: 100%;
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px 40px;
}
.tabs { display: flex; gap: 16px; margin-bottom: 24px; }
.tab { background: #f3f4f6; border: none; border-radius: 6px 6px 0 0; padding: 10px 24px; font-weight: 500; cursor: pointer; color: #6b7280; }
.tab.active { background: #fff; color: #6366f1; border-bottom: 2px solid #6366f1; }
.tab-content { display: none; }
.tab-content.active { display: block; }

.issue-card-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 24px;
  margin-top: 0;
}
@media (max-width: 1200px) {
  .issue-card-grid {
    grid-template-columns: 1fr;
  }
}
.issue-card {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  padding: 20px;
  display: flex;
  flex-direction: column;
  transition: all 0.2s;
}
.issue-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: #d1d5db;
}
.issue-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
  gap: 12px;
}
.issue-id-title {
  flex: 1;
}
.issue-id {
  font-size: 0.75rem;
  font-weight: 400;
  color: #9ca3af;
  display: block;
  margin-bottom: 8px;
}
.issue-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: #111827;
  margin: 0;
  line-height: 1.4;
}
.issue-severity {
  font-size: 0.8rem;
  font-weight: 600;
  border-radius: 12px;
  padding: 4px 12px;
  text-transform: capitalize;
  white-space: nowrap;
  flex-shrink: 0;
}
.issue-severity.high { background: #fee2e2; color: #dc2626; }
.issue-severity.medium { background: #fef3c7; color: #d97706; }
.issue-severity.low { background: #dbeafe; color: #2563eb; }
.issue-heuristic {
  color: #9ca3af;
  font-size: 0.8rem;
  margin-bottom: 12px;
  font-weight: 400;
}
.issue-time {
  color: #374151;
  font-size: 0.9rem;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.issue-time .time-label {
  font-weight: 600;
}
.issue-time .time-value {
  font-weight: 400;
}
.issue-evidence {
  color: #374151;
  margin-bottom: 14px;
  font-size: 0.9rem;
  line-height: 1.6;
  font-weight: 400;
}
.issue-evidence strong {
  color: #111827;
  display: block;
  margin-bottom: 6px;
  font-size: 0.9rem;
  font-weight: 600;
}
.issue-recommendations {
  margin-bottom: 16px;
  font-size: 0.9rem;
  flex: 1;
}
.issue-recommendations strong {
  color: #111827;
  display: block;
  margin-bottom: 8px;
  font-size: 0.9rem;
  font-weight: 600;
}
.issue-recommendations ul {
  margin: 0;
  padding-left: 18px;
}
.issue-recommendations li {
  margin-bottom: 4px;
  color: #374151;
  line-height: 1.6;
  font-weight: 400;
}
.issue-card-actions {
  margin-top: auto;
  display: flex;
  gap: 8px;
}
.copy-btn, .jira-btn {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 8px 14px;
  font-weight: 500;
  cursor: pointer;
  color: #374151;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  font-size: 0.85rem;
}
.copy-btn:hover {
  background: #f9fafb;
  border-color: #d1d5db;
}
.jira-btn:hover {
  background: #eff6ff;
  border-color: #bfdbfe;
  color: #2563eb;
}
.issue-card-image {
  width: 100%;
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 18px;
  background: #f3f4f6;
  border-radius: 8px 8px 0 0;
  overflow: hidden;
}
.frame-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px 8px 0 0;
}
.frame-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #a1a1aa;
  font-size: 2.5rem;
  background: #e5e7eb;
}
.placeholder-icon {
  font-size: 2.5rem;
}
.issue-card.highlighted {
  border: 2px solid #6366f1;
  box-shadow: 0 0 0 2px #6366f1;
}
.issue-timestamp {
  font-size: 0.98rem;
  color: #6366f1;
  font-weight: 500;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.timestamp-label {
  color: #6b7280;
  font-size: 0.97rem;
  font-weight: 400;
}
.timestamp-value {
  font-family: monospace;
  background: #f3f4f6;
  border-radius: 4px;
  padding: 2px 8px;
}
.summary-card {
  background: #f3f4f6;
  border-radius: 10px;
  padding: 18px 18px 12px 18px;
  margin: 0 0 18px 24px;
  box-shadow: 0 1px 4px rgba(99,102,241,0.06);
}
.summary-card h4 {
  margin: 0 0 6px 0;
  font-size: 1.08rem;
  color: #6366f1;
  font-weight: 700;
}
.summary-card p {
  margin: 0;
  color: #374151;
  font-size: 0.98rem;
}
.main-summary-card {
  background: #fff;
  border-radius: 14px;
  padding: 28px 32px 18px 32px;
  margin: 0 auto 32px auto;
  box-shadow: 0 2px 8px rgba(99,102,241,0.07);
  max-width: 700px;
  position: relative;
}
.main-summary-card h3 {
  margin: 0 0 10px 0;
  font-size: 1.15rem;
  color: #6366f1;
  font-weight: 700;
}
.main-summary-card h4 {
  margin: 18px 0 6px 0;
  font-size: 1.05rem;
  color: #6366f1;
  font-weight: 600;
}
.main-summary-card p {
  margin: 0;
  color: #374151;
  font-size: 1.08rem;
}
.workflow-steps-list {
  margin: 0 0 0 18px;
  padding: 0;
  color: #374151;
  font-size: 1rem;
}
.workflow-steps-list li {
  margin-bottom: 4px;
  list-style: disc;
}
.main-summary-card.full-width {
  max-width: none;
  width: 100%;
  margin: 0 0 32px 0;
  box-sizing: border-box;
}
.main-title { display: none; }

/* Collapsible Section Styles */
.collapsible-section {
  overflow: hidden;
}
.collapsible-header {
  cursor: pointer;
  user-select: none;
  margin-bottom: 0;
}
.collapsible-header h3 {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 0;
}
.chevron-icon {
  transition: transform 0.3s ease;
  flex-shrink: 0;
}
.collapsible-content {
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
}
.collapsible-content.expanded {
  max-height: 2000px;
  opacity: 1;
  padding-top: 12px;
}
.collapsible-content.collapsed {
  max-height: 0;
  opacity: 0;
  padding-top: 0;
}
.user-goal-text {
  margin: 0 0 12px 0;
  font-size: 1.08rem;
}

/* Next Steps Section */
.next-steps-section {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 24px;
  margin-top: 32px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.next-steps-heading {
  font-size: 1.1rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 16px 0;
}

.next-steps-list {
  list-style: disc;
  padding-left: 24px;
  margin: 0 0 20px 0;
}

.next-steps-list li {
  color: #374151;
  font-size: 0.95rem;
  line-height: 1.6;
  margin-bottom: 8px;
}

.next-steps-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.jira-epic-btn,
.design-task-btn {
  padding: 10px 18px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.jira-epic-btn {
  background: #1e293b;
  color: white;
}

.jira-epic-btn:hover {
  background: #0f172a;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.design-task-btn {
  background: #fff;
  color: #374151;
  border: 1px solid #e5e7eb;
}

.design-task-btn:hover {
  background: #f9fafb;
  border-color: #d1d5db;
}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
  .analysis-body {
    flex-direction: column;
  }

  .analysis-header {
    padding: 16px 20px 12px 20px;
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  .header-left {
    gap: 12px;
  }

  .report-title {
    font-size: 1.4rem;
  }

  .header-right {
    width: 100%;
    justify-content: flex-end;
  }

  .summary-stats-container {
    grid-template-columns: repeat(2, 1fr);
    padding: 12px 20px;
    gap: 10px;
  }

  .stat-value {
    font-size: 1.5rem;
  }

  .timeline-bar-container {
    padding: 10px 12px;
  }

  .timeline-heading {
    font-size: 0.75rem;
    margin-bottom: 6px;
  }

  .timeline-ranges {
    gap: 6px;
  }

  .timeline-range-btn {
    padding: 4px 8px;
    font-size: 0.7rem;
  }

  .workflow-analysis-section {
    padding: 10px 20px;
  }

  .workflow-toggle-btn {
    padding: 8px 12px;
    font-size: 0.85rem;
  }

  .analysis-main {
    padding: 20px 16px;
  }

  .main-summary-card {
    padding: 20px 16px;
    margin-bottom: 24px;
  }

  .issue-card-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .issue-card {
    padding: 20px 16px;
  }

  .error-container {
    padding: 2rem 1rem !important;
  }

  .error-actions {
    flex-direction: column;
    width: 100%;
  }

  .retry-button,
  .secondary-button {
    width: 100% !important;
    text-align: center !important;
    justify-content: center !important;
  }
}

@media (max-width: 480px) {
  .analysis-header {
    padding: 12px 16px 8px 16px;
  }

  .workflow-title {
    font-size: 1rem;
    margin-left: 8px;
    max-width: 250px;
  }

  .timeline-step {
    min-width: 100px;
    font-size: 0.85rem;
  }

  .analysis-main {
    padding: 16px 12px;
  }

  .main-summary-card {
    padding: 16px 12px;
  }

  .issue-card {
    padding: 16px 12px;
  }
}

/* Severity Info Icon */
.severity-info-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  margin-left: 4px;
  color: #9ca3af;
  transition: color 0.2s, transform 0.2s;
  vertical-align: middle;
  display: inline-flex;
  align-items: center;
  width: 14px;
  height: 14px;
  position: relative;
}

.severity-info-icon:hover {
  color: #6366f1;
  transform: scale(1.15);
}

.severity-info-icon:focus {
  outline: 2px solid #6366f1;
  outline-offset: 2px;
  border-radius: 50%;
}

.severity-info-icon svg {
  width: 14px;
  height: 14px;
}

/* Severity Tooltip on Hover */
.severity-info-icon::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(-8px);
  background: #1f2937;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.2s;
  z-index: 1000;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.severity-info-icon::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(-2px);
  border: 5px solid transparent;
  border-top-color: #1f2937;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.2s;
  z-index: 1000;
}

.severity-info-icon:hover::after,
.severity-info-icon:hover::before {
  opacity: 1;
  transform: translateX(-50%) translateY(-4px);
}

.severity-info-icon:hover::before {
  transform: translateX(-50%) translateY(1px);
}

/* Severity Modal */
.severity-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.severity-modal-content {
  background: white;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  position: relative;
  padding: 32px;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.severity-modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 28px;
  color: #9ca3af;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: background 0.2s, color 0.2s;
  line-height: 1;
}

.severity-modal-close:hover {
  background: #f3f4f6;
  color: #374151;
}

#severityModalBody h2 {
  margin: 0 0 24px 0;
  font-size: 1.75rem;
  font-weight: 700;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 12px;
}

#severityModalBody .severity-icon {
  font-size: 2rem;
}

#severityModalBody .severity-section {
  margin-bottom: 24px;
}

#severityModalBody .severity-section h3 {
  margin: 0 0 8px 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #374151;
}

#severityModalBody .severity-section p {
  margin: 0 0 12px 0;
  font-size: 1rem;
  line-height: 1.6;
  color: #6b7280;
}

#severityModalBody .severity-examples {
  background: #f9fafb;
  border-left: 3px solid #e5e7eb;
  padding: 12px 16px;
  border-radius: 4px;
}

#severityModalBody .severity-examples ul {
  margin: 8px 0 0 0;
  padding-left: 20px;
}

#severityModalBody .severity-examples li {
  margin-bottom: 6px;
  color: #374151;
  line-height: 1.5;
}

#severityModalBody .severity-timeline {
  background: #eff6ff;
  border-left: 3px solid #3b82f6;
  padding: 12px 16px;
  border-radius: 4px;
  font-weight: 600;
  color: #1e40af;
}

#severityModalBody .severity-calculation {
  background: #f0fdf4;
  border-left: 3px solid #22c55e;
  padding: 12px 16px;
  border-radius: 4px;
  font-size: 0.95rem;
  color: #166534;
  line-height: 1.6;
}

#severityModalBody .workflow-context {
  background: #fef3c7;
  border-left: 3px solid #f59e0b;
  padding: 12px 16px;
  border-radius: 4px;
  margin-top: 16px;
}

#severityModalBody .workflow-context strong {
  color: #92400e;
}

@media (max-width: 768px) {
  .severity-modal-content {
    width: 95%;
    padding: 24px 20px;
    max-height: 90vh;
  }

  #severityModalBody h2 {
    font-size: 1.5rem;
  }
}

/* Screenshot Modal Styles */
.screenshot-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.2s ease;
}

.screenshot-modal-content {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  animation: zoomIn 0.3s ease;
}

@keyframes zoomIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.screenshot-modal-close {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.9);
  border: none;
  font-size: 32px;
  color: #374151;
  cursor: pointer;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
  line-height: 1;
  z-index: 10001;
}

.screenshot-modal-close:hover {
  background: white;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.screenshot-thumbnail:hover {
  border-color: #6366f1;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
}

.screenshot-thumbnail:hover img {
  transform: scale(1.05);
  transition: transform 0.2s;
}

/* Show All Button */
.show-all-btn {
  background: #6366f1;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
}

.show-all-btn:hover {
  background: #4f46e5;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
}

.show-all-btn:active {
  transform: translateY(0);
}
</style>

<script nonce="<%= content_security_policy_nonce %>">
// Toggle workflow details
function toggleWorkflowDetails() {
  const details = document.getElementById('workflow-details');
  const chevron = document.querySelector('.chevron-workflow');

  if (details.classList.contains('collapsed')) {
    details.classList.remove('collapsed');
    details.classList.add('expanded');
    chevron.style.transform = 'rotate(180deg)';
  } else {
    details.classList.remove('expanded');
    details.classList.add('collapsed');
    chevron.style.transform = 'rotate(0deg)';
  }
}

// Toggle collapsible sections
function toggleCollapsible(headerElement) {
  const content = headerElement.nextElementSibling;
  const chevron = headerElement.querySelector('.chevron-icon');

  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    content.classList.add('collapsed');
    chevron.style.transform = 'rotate(-90deg)';
  } else {
    content.classList.remove('collapsed');
    content.classList.add('expanded');
    chevron.style.transform = 'rotate(0deg)';
  }
}

// Tab switching logic
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
tabs.forEach((tab, idx) => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tabContents.forEach(tc => tc.classList.remove('active'));
    tab.classList.add('active');
    tabContents[idx].classList.add('active');
  });
});

function copyIssue(auditId, idx) {
  const card = document.querySelectorAll('.issue-card')[idx];
  if (!card) return;
  let text = '';
  text += card.querySelector('.issue-title')?.innerText + '\n';
  text += card.querySelector('.issue-description')?.innerText + '\n';
  text += 'Recommendations:\n';
  card.querySelectorAll('.issue-recommendations li').forEach(li => {
    text += '- ' + li.innerText + '\n';
  });
  navigator.clipboard.writeText(text);

  // Track copy event
  if (typeof gtag !== 'undefined') {
    gtag('event', 'issue_copy', {
      event_category: 'engagement',
      audit_id: auditId,
      issue_index: idx
    });
  }
}

function trackJiraIntegration(auditId, idx) {
  // Track JIRA integration usage
  if (typeof gtag !== 'undefined') {
    gtag('event', 'jira_integration', {
      event_category: 'engagement',
      audit_id: auditId,
      issue_index: idx
    });
  }

  // Add future JIRA integration logic here
  alert('JIRA integration coming soon!');
}

// Highlight feedback card when timeline step is clicked
function highlightCard(idx) {
  const cards = document.querySelectorAll('.issue-card');
  const showAllContainer = document.getElementById('show-all-container');

  cards.forEach((card, i) => {
    card.classList.remove('highlighted');
    if (idx === 'all' || idx === undefined) {
      card.style.display = '';
    } else if (i === idx) {
      card.classList.add('highlighted');
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });

  // Show or hide the "Show All Issues" button
  if (showAllContainer) {
    if (idx === 'all' || idx === undefined) {
      showAllContainer.style.display = 'none';
    } else {
      showAllContainer.style.display = 'block';
    }
  }

  // Track timeline navigation
  if (typeof gtag !== 'undefined' && idx !== 'all' && idx !== undefined) {
    gtag('event', 'timeline_navigation', {
      event_category: 'engagement',
      audit_id: <%= @audit.id %>,
      issue_index: idx
    });
  }
}

// Severity Info Modal Functions
function openSeverityInfo(severity) {
  const modal = document.getElementById('severityModal');
  const modalBody = document.getElementById('severityModalBody');

  // Get workflow criticality if available
  <% workflow_criticality = @audit.parsed_llm_response.dig('workflowSummary', 'workflowCriticality') if @audit.completed? || @audit.status == 'partial' %>
  const workflowCriticality = '<%= workflow_criticality || 'Standard' %>';
  const workflowTitle = '<%= @audit.parsed_llm_response.dig('workflowSummary', 'workflowtitle') if @audit.completed? || @audit.status == 'partial' %>';

  const severityContent = {
    high: {
      icon: 'üî¥',
      title: 'High Severity',
      definition: 'This issue is actively preventing users from completing important tasks or causing significant frustration. It\'s costing you conversions, revenue, or users right now.',
      examples: [
        'Checkout button is hard to find ‚Üí Users abandon their cart',
        'Form errors don\'t clearly show what\'s wrong ‚Üí Users give up',
        'No confirmation after payment ‚Üí Users panic and call support',
        'Critical workflow blocked or severely impaired'
      ],
      timeline: '‚ö° Fix this week',
      calculation: 'High severity issues are identified based on <strong>critical user impact</strong>, <strong>task blocking</strong>, and <strong>workflow criticality</strong>. Issues in business-critical flows (like checkout or payment) automatically receive higher severity ratings.'
    },
    medium: {
      icon: 'üü°',
      title: 'Medium Severity',
      definition: 'This issue is making your product harder to use than it should be. Users can work around it, but they\'re annoyed. Some less patient users might leave.',
      examples: [
        'Search results are confusing ‚Üí Users spend extra time finding what they need',
        'Settings are hard to find ‚Üí Users can\'t customize easily',
        'Navigation labels are unclear ‚Üí Users click multiple times',
        'Form lacks helpful guidance or real-time validation'
      ],
      timeline: 'üìÖ Fix this month',
      calculation: 'Medium severity issues create <strong>noticeable friction</strong> but don\'t block task completion. Severity is adjusted based on workflow type - the same issue in settings gets Medium severity, while in checkout it would be High.'
    },
    low: {
      icon: 'üîµ',
      title: 'Low Severity',
      definition: 'This is a polish issue. Users can complete all tasks fine, but fixing this would make your product feel more professional or slightly smoother.',
      examples: [
        'Inconsistent button spacing in footer',
        'A label could be clearer but users figure it out',
        'Animation timing feels slightly off',
        'Minor visual inconsistencies that don\'t affect usability'
      ],
      timeline: 'üé® Fix when you have time',
      calculation: 'Low severity issues are <strong>cosmetic or minor polish items</strong>. They don\'t significantly impact user experience. Issues in low-impact workflows (like help pages) typically receive Low severity ratings unless they block critical tasks.'
    }
  };

  const content = severityContent[severity];
  if (!content) return;

  let workflowContextHTML = '';
  if (workflowCriticality && workflowTitle) {
    const criticalityDescriptions = {
      'Business-Critical': 'Business-Critical workflows (checkout, payment, signup, login) receive the highest severity ratings because issues here directly impact revenue and core business functions.',
      'High-Impact': 'High-Impact workflows (onboarding, core features, search) are essential to user success, so issues receive elevated severity ratings.',
      'Standard': 'Standard workflows (settings, profile, preferences) receive baseline severity ratings since issues here are less likely to block critical tasks.',
      'Low-Impact': 'Low-Impact workflows (help pages, about pages) receive lower severity ratings since these areas are less critical to core user tasks.'
    };

    workflowContextHTML = `
      <div class="workflow-context">
        <strong>Your Workflow:</strong> "${workflowTitle}" was classified as <strong>${workflowCriticality}</strong>.<br>
        ${criticalityDescriptions[workflowCriticality] || ''}
      </div>
    `;
  }

  modalBody.innerHTML = `
    <h2>
      <span class="severity-icon">${content.icon}</span>
      ${content.title}
    </h2>

    <div class="severity-section">
      <h3>What it means</h3>
      <p>${content.definition}</p>
    </div>

    <div class="severity-section">
      <h3>Examples</h3>
      <div class="severity-examples">
        <ul>
          ${content.examples.map(ex => `<li>${ex}</li>`).join('')}
        </ul>
      </div>
    </div>

    <div class="severity-section">
      <h3>When to fix</h3>
      <div class="severity-timeline">${content.timeline}</div>
    </div>

    <div class="severity-section">
      <h3>How it's calculated</h3>
      <div class="severity-calculation">
        ${content.calculation}
      </div>
      ${workflowContextHTML}
    </div>
  `;

  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  // Track modal open event
  if (typeof gtag !== 'undefined') {
    gtag('event', 'severity_info_opened', {
      event_category: 'engagement',
      severity: severity,
      audit_id: <%= @audit.id %>
    });
  }
}

function closeSeverityModal(event) {
  // If event is passed and target is not the backdrop, don't close
  if (event && event.target.classList.contains('severity-modal-content')) {
    return;
  }

  const modal = document.getElementById('severityModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

// Close modal on ESC key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeSeverityModal();
  }
});

// ========================================
// EVENT LISTENERS (CSP Compliant)
// ========================================

// Severity info icon click handlers
document.querySelectorAll('.severity-info-icon').forEach(function(button) {
  button.addEventListener('click', function() {
    const severity = this.getAttribute('data-severity');
    openSeverityInfo(severity);
  });
});

// Timeline dot container click handlers
document.querySelectorAll('.timeline-dot-container').forEach(function(container) {
  container.addEventListener('click', function() {
    const idx = parseInt(this.getAttribute('data-issue-index'), 10);
    highlightCard(idx);
  });
});

// Workflow toggle button click handler
const workflowToggleBtn = document.getElementById('workflow-toggle-btn');
if (workflowToggleBtn) {
  workflowToggleBtn.addEventListener('click', toggleWorkflowDetails);
}

// Copy button click handlers
document.querySelectorAll('.copy-btn').forEach(function(button) {
  button.addEventListener('click', function() {
    const auditId = parseInt(this.getAttribute('data-audit-id'), 10);
    const idx = parseInt(this.getAttribute('data-issue-index'), 10);
    copyIssue(auditId, idx);
  });
});

// Jira button click handlers
document.querySelectorAll('.jira-btn').forEach(function(button) {
  button.addEventListener('click', function() {
    const auditId = parseInt(this.getAttribute('data-audit-id'), 10);
    const idx = parseInt(this.getAttribute('data-issue-index'), 10);
    trackJiraIntegration(auditId, idx);
  });
});

// Modal close handlers
const severityModal = document.getElementById('severityModal');
const modalCloseBtn = document.querySelector('.severity-modal-close');

if (severityModal) {
  // Close on backdrop click
  severityModal.addEventListener('click', function(event) {
    if (event.target === severityModal) {
      closeSeverityModal();
    }
  });
}

if (modalCloseBtn) {
  // Close on X button click
  modalCloseBtn.addEventListener('click', function() {
    closeSeverityModal();
  });
}

// Prevent modal content clicks from closing modal
const modalContent = document.querySelector('.severity-modal-content');
if (modalContent) {
  modalContent.addEventListener('click', function(event) {
    event.stopPropagation();
  });
}

// Header button handlers
const filterBtn = document.getElementById('filter-btn');
if (filterBtn) {
  filterBtn.addEventListener('click', function() {
    alert('Filters coming soon!');
  });
}

const exportBtn = document.getElementById('export-btn');
if (exportBtn) {
  exportBtn.addEventListener('click', function() {
    window.print();
  });
}

// Screenshot Modal Functions
function openScreenshotModal(screenshotImg) {
  const modal = document.getElementById('screenshotModal');
  const modalImage = document.getElementById('screenshotModalImage');

  if (screenshotImg) {
    modalImage.src = screenshotImg.src;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeScreenshotModal() {
  const modal = document.getElementById('screenshotModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

// Screenshot modal event listeners
const screenshotModal = document.getElementById('screenshotModal');
const screenshotModalClose = document.querySelector('.screenshot-modal-close');

if (screenshotModal) {
  // Close on backdrop click
  screenshotModal.addEventListener('click', function(event) {
    if (event.target === screenshotModal) {
      closeScreenshotModal();
    }
  });
}

if (screenshotModalClose) {
  // Close on X button click
  screenshotModalClose.addEventListener('click', function() {
    closeScreenshotModal();
  });
}

// Close screenshot modal on ESC key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('screenshotModal');
    if (modal && modal.style.display === 'flex') {
      closeScreenshotModal();
    }
  }
});

// Add click event listeners to all screenshot thumbnails
document.querySelectorAll('.screenshot-thumbnail').forEach(function(thumbnail) {
  thumbnail.addEventListener('click', function() {
    const img = this.querySelector('.issue-screenshot-img');
    if (img) {
      openScreenshotModal(img);
    }
  });
});

// Next Steps button handlers
const jiraEpicBtn = document.getElementById('jira-epic-btn');
if (jiraEpicBtn) {
  jiraEpicBtn.addEventListener('click', function() {
    alert('Jira Epic generation coming soon!');
  });
}

const designTaskBtn = document.getElementById('design-task-btn');
if (designTaskBtn) {
  designTaskBtn.addEventListener('click', function() {
    alert('Design Task creation coming soon!');
  });
}

// Show All Issues button handler
const showAllBtn = document.getElementById('show-all-btn');
if (showAllBtn) {
  showAllBtn.addEventListener('click', function() {
    highlightCard('all');
  });
}
</script>
<% end %>
        </main>
      </div>
    </div>
  </body>
</html>
