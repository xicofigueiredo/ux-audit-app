<h2>UX Video Audits</h2>

<% if flash[:alert] %>
  <div class="flash-message flash-error" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
    <svg style="width: 20px; height: 20px; color: #dc2626; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
    </svg>
    <span style="color: #7f1d1d; font-weight: 500;"><%= flash[:alert] %></span>
  </div>
<% end %>

<% if flash[:notice] %>
  <div class="flash-message flash-success" style="background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
    <svg style="width: 20px; height: 20px; color: #059669; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span style="color: #047857; font-weight: 500;"><%= flash[:notice] %></span>
  </div>
<% end %>
<div class="upload-info" style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
    <svg style="width: 24px; height: 24px; color: #0284c7; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <h3 style="color: #0c4a6e; font-weight: 600; margin: 0;">Upload Requirements</h3>
  </div>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <svg style="width: 16px; height: 16px; color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      <span style="color: #0c4a6e; font-size: 0.9rem;">Max 60 seconds</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <svg style="width: 16px; height: 16px; color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      <span style="color: #0c4a6e; font-size: 0.9rem;">MP4, MOV, AVI</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <svg style="width: 16px; height: 16px; color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      <span style="color: #0c4a6e; font-size: 0.9rem;">Screen recordings welcome</span>
    </div>
  </div>
</div>

<div class="upload-section" id="drop-zone">
  <%= form_with(model: VideoAudit.new, local: true, multipart: true, id: 'video-upload-form') do |f| %>
    <div class="field">
      <div class="drop-zone-content">
        <div class="upload-icon" style="margin-bottom: 1rem;">
          <svg style="width: 48px; height: 48px; color: #6b7280; margin: 0 auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
        </div>
        <div class="upload-text" style="text-align: center; margin-bottom: 1rem;">
          <p style="font-size: 1.1rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
            <span class="drag-text">Drag and drop your video here</span>
            <span class="upload-text-mobile" style="display: none;">Tap to select your video</span>
          </p>
          <p style="color: #6b7280; font-size: 0.9rem;">or click to browse files</p>
        </div>
        <%= f.file_field :video, accept: 'video/mp4,video/mov,video/avi,video/*', class: 'file-input', id: 'video-file-input' %>
        <div class="file-preview" id="file-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 6px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <svg style="width: 24px; height: 24px; color: #6366f1;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16l13-8L7 4z"></path>
            </svg>
            <div style="flex: 1;">
              <p id="file-name" style="font-weight: 600; color: #374151; margin: 0 0 4px 0;"></p>
              <p id="file-size" style="color: #6b7280; font-size: 0.9rem; margin: 0;"></p>
            </div>
            <button type="button" id="remove-file" style="color: #ef4444; background: none; border: none; cursor: pointer;">
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="button-center">
      <%= f.submit "Analyze Video", class: 'upload-button', id: 'submit-button', disabled: true %>
    </div>
  <% end %>
</div>

<div id="analysis-results"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('video-file-input');
  const filePreview = document.getElementById('file-preview');
  const fileName = document.getElementById('file-name');
  const fileSize = document.getElementById('file-size');
  const removeButton = document.getElementById('remove-file');
  const submitButton = document.getElementById('submit-button');
  const form = document.getElementById('video-upload-form');

  // Mobile detection
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if (isMobile) {
    document.querySelector('.drag-text').style.display = 'none';
    document.querySelector('.upload-text-mobile').style.display = 'inline';
  }

  // Handle file input change
  fileInput.addEventListener('change', handleFileSelect);

  // Handle drag and drop (only for non-mobile)
  if (!isMobile) {
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
      if (!dropZone.contains(e.relatedTarget)) {
        dropZone.classList.remove('drag-over');
      }
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect();
      }
    });
  }

  // Handle file selection
  function handleFileSelect() {
    const file = fileInput.files[0];
    if (file) {
      // Validate file type
      const validTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/quicktime'];
      if (!validTypes.includes(file.type) && !file.type.startsWith('video/')) {
        alert('Please select a valid video file (MP4, MOV, AVI)');
        resetFileInput();
        return;
      }

      // Show file preview
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      filePreview.style.display = 'block';
      submitButton.disabled = false;
      submitButton.style.opacity = '1';
      submitButton.style.cursor = 'pointer';
    }
  }

  // Remove file
  removeButton.addEventListener('click', resetFileInput);

  function resetFileInput() {
    fileInput.value = '';
    filePreview.style.display = 'none';
    submitButton.disabled = true;
    submitButton.style.opacity = '0.6';
    submitButton.style.cursor = 'not-allowed';
  }

  // Format file size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Handle form submission with loading state
  form.addEventListener('submit', function(e) {
    if (fileInput.files.length === 0) {
      e.preventDefault();
      alert('Please select a video file first');
      return;
    }

    // Show loading state
    submitButton.textContent = 'Uploading...';
    submitButton.disabled = true;

    // Add a subtle loading animation
    submitButton.style.position = 'relative';
    submitButton.innerHTML = `
      <span style="display: flex; align-items: center; gap: 8px;">
        <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Uploading...
      </span>
    `;

    // The form will submit normally (no preventDefault)
  });
});
</script>

<style>
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>

<!-- Help section -->
<div class="help-section" style="background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 1.5rem; margin-top: 2rem;">
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
    <svg style="width: 24px; height: 24px; color: #ca8a04; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
    </svg>
    <h3 style="color: #92400e; font-weight: 600; margin: 0;">ðŸ’¡ Pro Tips for Better Results</h3>
  </div>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    <div style="display: flex; align-items: flex-start; gap: 8px;">
      <span style="color: #059669; font-weight: bold; font-size: 1.2rem; line-height: 1;">â€¢</span>
      <span style="color: #92400e; font-size: 0.9rem;">Record your screen while using your app normally</span>
    </div>
    <div style="display: flex; align-items: flex-start; gap: 8px;">
      <span style="color: #059669; font-weight: bold; font-size: 1.2rem; line-height: 1;">â€¢</span>
      <span style="color: #92400e; font-size: 0.9rem;">Show complete user flows (login â†’ action â†’ result)</span>
    </div>
    <div style="display: flex; align-items: flex-start; gap: 8px;">
      <span style="color: #059669; font-weight: bold; font-size: 1.2rem; line-height: 1;">â€¢</span>
      <span style="color: #92400e; font-size: 0.9rem;">Keep it under 60 seconds for best analysis</span>
    </div>
  </div>
</div>

<% if defined?(@audits) && @audits.any? %>
  <div class="past-audits">
    <h3>Previous Audits</h3>
    <% @audits.each do |audit| %>
      <div class="audit-item <%= audit.status %>">
        <div class="audit-info" onclick="window.location.href='<%= video_audit_path(audit) %>'" style="cursor: pointer;">
          <span class="video-title"><%= audit.video.identifier %></span>
          <div class="audit-meta">
            <span class="timestamp"><%= time_ago_in_words(audit.created_at) %> ago</span>
            <span class="status <%= audit.status %>"><%= audit.status %></span>
            <div onclick="event.stopPropagation();">
              <%= button_to video_audit_path(audit), method: :delete, class: "delete-button", form: { class: "delete-form" }, data: { confirm: "Are you sure you want to delete this audit? This action cannot be undone." } do %>
                Delete
              <% end %>
            </div>
          </div>
        </div>
        <% if audit.failed? %>
          <div class="error-message">
            <%= audit.llm_response %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state" style="text-align: center; padding: 3rem 2rem; margin-top: 2rem;">
    <div style="margin-bottom: 1.5rem;">
      <svg style="width: 64px; height: 64px; color: #d1d5db; margin: 0 auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16l13-8L7 4z"></path>
      </svg>
    </div>
    <h3 style="color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">No audits yet</h3>
    <p style="color: #9ca3af; margin-bottom: 1.5rem;">Upload your first video to get AI-powered UX insights!</p>
    <div style="color: #6b7280; font-size: 0.9rem;">
      <p style="margin: 0;">ðŸ‘† Use the upload area above to get started</p>
    </div>
  </div>
<% end %>

<style>
  .upload-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 2px dashed #e5e7eb;
    border-radius: 8px;
    text-align: center;
    transition: all 0.3s ease;
  }

  .upload-section.drag-over {
    border-color: #3B82F6;
    background-color: #EFF6FF;
  }

  .drop-zone-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .file-input {
    margin-bottom: 1rem;
  }

  .upload-button {
    padding: 12px 24px;
    background: #3B82F6;
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    opacity: 0.6;
    cursor: not-allowed;
  }

  .upload-button:not(:disabled) {
    opacity: 1;
    cursor: pointer;
  }

  .upload-button:not(:disabled):hover {
    background: #2563EB;
    transform: translateY(-1px);
  }

  .upload-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .past-audits {
    margin-top: 2rem;
  }

  .audit-item {
    padding: 16px;
    border: 1px solid #e5e7eb;
    margin: 8px 0;
    border-radius: 8px;
    display: block;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
  }

  .audit-item:hover {
    border-color: #3B82F6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .audit-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .status.completed {
    background: #D1FAE5;
    color: #065F46;
  }

  .status.failed {
    background: #FEE2E2;
    color: #991B1B;
  }

  .status.pending {
    background: #FEF3C7;
    color: #92400E;
  }

  .error-message {
    margin-top: 8px;
    font-size: 0.875rem;
    color: #991B1B;
  }

  .timestamp {
    color: #6B7280;
  }

  .audit-meta {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .delete-button {
    padding: 6px 10px;
    background: #EF4444;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 1rem;
    margin-left: 8px;
    display: flex;
    align-items: center;
  }

  .delete-button:hover {
    background: #DC2626;
  }

  .delete-form {
    margin: 0;
    display: inline;
  }

  .button-center {
    text-align: center;
    margin-top: 1rem;
  }
</style>